import fs from 'fs'
import path from 'path'
import matter from 'gray-matter'

const CONTENT_DIR = path.join(process.cwd(), 'content/blog')
const OUTPUT_FILE = path.join(process.cwd(), 'data/youtube-index.ts')

/**
 * Scans MDX files for YouTube links and embeds to build a searchable index.
 */
function generateYoutubeIndex() {
  console.log('ðŸ” Indexing YouTube content...')
  
  const files = fs.readdirSync(CONTENT_DIR).filter(f => f.endsWith('.mdx'))
  const index = []

  files.forEach(file => {
    const filePath = path.join(CONTENT_DIR, file)
    const content = fs.readFileSync(filePath, 'utf8')
    const { data, content: body } = matter(content)
    
    // Match <YouTubeEmbed id="..." /> or youtube.com/watch?v=... or youtu.be/...
    const embedMatches = body.match(/<YouTubeEmbed[^>]*id=["']([^"']+)["'][^>]*>/g) || []
    const rawMatches = body.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/g) || []
    
    const ids = new Set([
      ...embedMatches.map(m => m.match(/id=["']([^"']+)["']/)[1]),
      ...rawMatches.map(m => m.split('/').pop().split('v=').pop())
    ])

    if (ids.size > 0) {
      index.push({
        slug: file.replace('.mdx', ''),
        title: data.title,
        videoIds: Array.from(ids),
        category: data.category || 'Uncategorized'
      })
    }
  })

  // Preserve manually maintained section (youtubeChannels) above the auto-generated marker
  let manualSection = ''
  if (fs.existsSync(OUTPUT_FILE)) {
    const existing = fs.readFileSync(OUTPUT_FILE, 'utf8')
    const marker = '// Auto-generated by scripts/generate-youtube-index.mjs'
    const markerIndex = existing.indexOf(marker)
    if (markerIndex > 0) {
      manualSection = existing.substring(0, markerIndex)
    }
  }

  const autoGenerated = `// Auto-generated by scripts/generate-youtube-index.mjs
// Last updated: ${new Date().toISOString()}

export interface YoutubeIndexEntry {
  slug: string
  title: string
  videoIds: string[]
  category: string
}

export const youtubeIndex: YoutubeIndexEntry[] = ${JSON.stringify(index, null, 2)};
`

  fs.writeFileSync(OUTPUT_FILE, manualSection + autoGenerated)
  console.log(`âœ… Indexed ${index.length} articles with YouTube content.`)
}

generateYoutubeIndex()
